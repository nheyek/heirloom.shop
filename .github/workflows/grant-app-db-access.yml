name: Grant App DB Access

on:
    workflow_dispatch: # run manually whenever needed

jobs:
    grants:
        runs-on: ubuntu-latest
        steps:
            - name: Install doctl via snap
              run: sudo snap install doctl

            - name: Authenticate doctl
              run: doctl auth init -t ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Install PostgreSQL client
              run: sudo apt-get update && sudo apt-get install -y postgresql-client

            - name: Get runner IPv4
              id: get_ip
              run: echo "ip=$(curl -4 -s ifconfig.me)" >> $GITHUB_OUTPUT

            - name: Add runner IP to DigitalOcean trusted sources
              run: |
                  echo "Adding ${{ steps.get_ip.outputs.ip }} to trusted sources..."
                  doctl databases firewalls append ${{ secrets.DEV_DATABASE_ID }} \
                    --rule ip_addr:${{ steps.get_ip.outputs.ip }}

              env:
                  DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Grant heirloom user full access
              env:
                  DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
              run: |
                  echo "Granting privileges to user 'heirloom' on DB 'heirloom'..."

                  psql "$DATABASE_URL" -v ON_ERROR_STOP=1 <<'SQL'
                    -- Ensure the heirloom user can connect to the database
                    GRANT CONNECT ON DATABASE heirloomdb TO heirloom;

                    -- Schema privileges
                    GRANT USAGE, CREATE ON SCHEMA public TO heirloom;

                    -- Object privileges
                    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO heirloom;
                    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO heirloom;

                    -- Default privileges for future objects
                    ALTER DEFAULT PRIVILEGES IN SCHEMA public
                      GRANT ALL ON TABLES TO heirloom;
                    ALTER DEFAULT PRIVILEGES IN SCHEMA public
                      GRANT ALL ON SEQUENCES TO heirloom;

            - name: Remove runner IP from DigitalOcean trusted sources
              if: always()
              run: |
                  RUNNER_IP=${{ steps.get_ip.outputs.ip }}
                  echo "Looking up rule for $RUNNER_IP..."

                  # Get firewall rules in JSON
                  RULES=$(doctl databases firewalls list ${{ secrets.DEV_DATABASE_ID }} --output json)

                  echo "Current rules: $RULES"

                  # Extract UUID for the rule with the matching IP
                  RULE_ID=$(echo "$RULES" | jq -r ".[] | select(.value==\"$RUNNER_IP\") | .uuid")

                  if [ -n "$RULE_ID" ] && [ "$RULE_ID" != "null" ]; then
                  echo "Removing firewall rule $RULE_ID"
                  doctl databases firewalls remove ${{ secrets.DEV_DATABASE_ID }} --uuid $RULE_ID
                  else
                  echo "⚠️ No firewall rule found for $RUNNER_IP, skipping removal."
                  fi

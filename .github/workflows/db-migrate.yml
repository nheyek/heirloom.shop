name: Deploy Database Schema

on: workflow_dispatch

jobs:
    migrate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install doctl via snap
              run: sudo snap install doctl

            - name: Authenticate doctl
              run: doctl auth init -t ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Get runner IPv4
              id: get_ip
              run: echo "ip=$(curl -4 -s ifconfig.me)" >> $GITHUB_OUTPUT

            - name: Add runner IP to DigitalOcean trusted sources
              run: |
                  echo "Adding ${{ steps.get_ip.outputs.ip }} to trusted sources..."
                  doctl databases firewalls append ${{ secrets.DEV_DATABASE_ID }} \
                    --rule ip_addr:${{ steps.get_ip.outputs.ip }}

              env:
                  DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Wait for firewall propagation
              run: sleep 20

            - name: Install dbmate
              run: |
                  curl -fsSL -o /usr/local/bin/dbmate \
                    https://github.com/amacneil/dbmate/releases/latest/download/dbmate-linux-amd64
                  chmod +x /usr/local/bin/dbmate

            - name: Run migrations
              env:
                  DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
              run: dbmate up

            - name: Remove runner IP from DigitalOcean trusted sources
              if: always()
              run: |
                  RUNNER_IP=${{ steps.get_ip.outputs.ip }}
                  echo "Looking up rule for $RUNNER_IP..."

                  # Get firewall rules in JSON
                  RULES=$(doctl databases firewalls list ${{ secrets.DEV_DATABASE_ID }} --output json)

                  echo "Current rules: $RULES"

                  # Extract UUID for the rule with the matching IP
                  RULE_ID=$(echo "$RULES" | jq -r ".[] | select(.value==\"$RUNNER_IP\") | .uuid")

                  if [ -n "$RULE_ID" ] && [ "$RULE_ID" != "null" ]; then
                  echo "Removing firewall rule $RULE_ID"
                  doctl databases firewalls remove "$RULE_ID"
                  else
                  echo "⚠️ No firewall rule found for $RUNNER_IP, skipping removal."
                  fi
